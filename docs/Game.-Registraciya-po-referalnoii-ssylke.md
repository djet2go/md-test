# Регистрация по реферальной ссылке


| Параметр   | Значение                                              |
| ---------- | ----------------------------------------------------- |
| Фича-овнер | [[Мякушка Юлия]]                                      | 
| Epic       | [VC-4386](https://bptco.atlassian.net/browse/VC-4386) |


## Текст вводной

### Реферальная система

> Нам необходимо реализовать регистрацию по реферальной ссылке (форму регистрации, отдельная страница), хвост может быть как телефон, логин, также емаил
> 
> `https://game.rentierworld.com/auth/register?ref=:bc_id`
> 
> При регистрации задействовать следующие поля
> - **"Ваш рекомендатель"**:
>     - Аватар
>     - Юзер нейм
>     - Имя Фамилия
> - **"Имя"**
> - **"Фамилия"**
> - **"Телефон"**
> - **"Емаил"**
> - **"Пароль"**
> - **"Подтверждение пароля"**
> 
> Если человек приходит без реф ссылки, то дополнительно отобразить
> 
> **"Укажите логин/телефон/email своего рекомендателя"**
> 
> тут поле ввода, 
> 
> после ввода проверяем есть ли этот пользователь в бинаре в БЦ и если есть то ок подсветить зелененьким
> 
> Если нет то выдать сообщение, что такого пользователя нет.
> 
> API колы для регистрации выдаст [[Гур Александр]]
> 
> На странице Авторизации внизу под формой написать
> 
> **"Еще нет аккаунта BPT? Зарегистрируйтесь"** (это слово ссылкой на форму регистрации)
> 
> На страницы регистрации 
> 
> **"Уже есть аккаунт? Войдите"**

### Метод БЦ **Регистрация нового пользователя**

`POST /api/rentier/user/add`

params:

- `login`
- `firstName`
- `secondName`
- `phoneNumber`
- `email`
- `password`
- `sponsor` (`bc_id`)

если все ок в ответе `200`, в случае ошибки, ошибка в `error`

возможны варианты `error`:
- не найден спонсор (`error_sponsor_not_found`)
- логин уже занят (`error_login_has_already_been_taken`)
- телефон уже занят (`error_phone_has_already_been_taken`)
- емейл уже занят (`error_email_has_already_been_taken`)

## Описание флоу

### Генерация реферальной ссылки
В профайле делаем возможность скопировать реферальную ссылку.
Формируем реверальную ссылку так: `https://game.rentierworld.com/auth/register?ref=:bc_id`

### Регистрация

При переходе на регистрацию получаем из БЦ профайл рекомендателя и отображаем информацию по нему. Если параметр `ref` не передан или такого рекомендателя нет, то вместо информации по рекомендателю отображаем поле **"Укажите логин/телефон/email своего рекомендателя"**

После того, как пользователь указал рекомендателя идем на БЦ и получаем его профайл. Если есть подсвечиваем зеленым, если нет - красным. Под полем пишем, что такой пользователь не найден.

Кроме этого на странице отображаются поля:
- **"Имя"**
- **"Фамилия"**
- **"Телефон"**
- **"Емаил"**
- **"Пароль"**
- **"Подтверждение пароля"**
- **"Уже есть аккаунт? Войдите"** - ссылка на авторизацию

После указания всех данных вызываем проксированный роут БЦ `POST /api/rentier/user/add` и создаем игрока в нашей БД

Пользователю отображаем уведомление об успешной регистрации и ссылку на кабинет БЦ (например для дева, https://bc-dev-bpt.ooo.ua/ - при клике открываем в новом окне). А так же кнопку "Войти".

### Логин

На странице логина внизу добавить ссылку **"Еще нет аккаунта BPT? Зарегистрируйтесь"**, которая ведет на форму регистрации.


## Декомпозиция

### Story. Back-end
#### Task. Сделать роут для регистрации

| Параметр    | Значение          |
| ----------- | ----------------- |
| Эстимейт    | 4h                |
| Сложность   | 2sp               |
| Исполнитель | [[Ельцов Никита]] | 
| Компоненты  | game-trader       |
| Department  | Back-end          |

**Запрос:**
- `login`
- `firstName`
- `secondName`
- `phoneNumber`
- `email`
- `password`
- `sponsor` (один из: `bc_id`, `phone`, `login`, `email`)

**Ответ:**
- JWT-токен (как в ответе метода `/v4/game-trader/players/login`) или ошибку

**Логика:**

1. Принимать запрос от фронта
2. После чего:
- вызывать метод регистрации игрока в БЦ (`POST /api/rentier/user/add`)
- создавать игрока у нас в БД
- выполнить авторизацияю игрока и возвращать токен на фронт


### Story. Design
#### Task. Сделать дизайн флоу регистрации

| Параметр    | Значение                |
| ----------- | ----------------------- |
| Эстимейт    | 8h                      |
| Сложность   | 5sp                     |
| Исполнитель | [[Брусенцов Александр]] |
| Компоненты  | game-ui                 |
| Department  | Design                  | 

При переходе на регистрацию получаем из БЦ профайл рекомендателя и отображаем информацию по нему. Если параметр `ref` не передан или такого рекомендателя нет, то вместо информации по рекомендателю отображаем поле **"Укажите логин/телефон/email своего рекомендателя"**

После того, как пользователь указал рекомендателя идем на БЦ и получаем его профайл. Если есть подсвечиваем зеленым, если нет - красным. Под полем пишем, что такой пользователь не найден.

Кроме этого на странице отображаются поля:
- **"Имя"**
- **"Фамилия"**
- **"Телефон"**
- **"Емаил"**
- **"Пароль"**
- **"Подтверждение пароля"**
- **"Уже есть аккаунт? Войдите"** - ссылка на авторизацию

После указания всех данных вызываем проксированный роут БЦ `POST /api/rentier/user/add` и создаем игрока в нашей БД

Пользователю отображаем уведомление об успешной регистрации и ссылку на кабинет БЦ (например для дева, https://bc-dev-bpt.ooo.ua/ - при клике открываем в новом окне). А так же кнопку "Войти".

#### Task. Добавить в дизайн профайла "Скопировать реферальную ссылку"

| Параметр    | Значение                |
| ----------- | ----------------------- |
| Эстимейт    | 1h                      |
| Сложность   | 1sp                     |
| Исполнитель | [[Брусенцов Александр]] |
| Компоненты  | game-ui                 |
| Department  | Design                  |

В выпадашку профайла добавить пункт "Скопировать реферальную ссылку"

#### Task. Добавить в дизайн логинки ссылку на регистрацию

| Параметр    | Значение                |
| ----------- | ----------------------- |
| Эстимейт    | 1h                      |
| Сложность   | 1sp                     |
| Исполнитель | [[Брусенцов Александр]] |
| Компоненты  | game-ui                 |
| Department  | Design                  | 

Внизу формы добавить ссылку "Еще нет аккаунта BPT? Зарегистрируйтесь"


### Story. Front-end
#### Task. Добавить в профайл "Скопировать реферальную ссылку"

| Параметр    | Значение          |
| ----------- | ----------------- |
| Эстимейт    | 2h                |
| Сложность   | 1sp               |
| Исполнитель | [[Юминов Михаил]] |
| Компоненты  | game-ui           |
| Department  | Front-end         | 

В профайле делаем возможность скопировать реферальную ссылку.
Формируем реверальную ссылку так: `https://game.rentierworld.com/auth/register?ref=:bc_id`

#### Task. Добавить на логинке ссылку на регистрацию

| Параметр    | Значение          |
| ----------- | ----------------- |
| Эстимейт    | 1h                |
| Сложность   | 1sp               |
| Исполнитель | [[Юминов Михаил]] |
| Компоненты  | game-ui           |
| Department  | Front-end         |

Внизу формы добавить ссылку **"Еще нет аккаунта BPT? Зарегистрируйтесь"**

#### Task. Добавить страницу регистрации

| Параметр    | Значение          |
| ----------- | ----------------- |
| Эстимейт    | 8h                |
| Сложность   | 5sp               |
| Исполнитель | [[Юминов Михаил]] |
| Компоненты  | game-ui           |
| Department  | Front-end         | 

При переходе на регистрацию получаем из БЦ профайл рекомендателя и отображаем информацию по нему. Если параметр `ref` не передан или такого рекомендателя нет, то вместо информации по рекомендателю отображаем поле **"Укажите логин/телефон/email своего рекомендателя"**

После того, как пользователь указал рекомендателя идем на БЦ и получаем его профайл. Если есть подсвечиваем зеленым, если нет - красным. Под полем пишем, что такой пользователь не найден.

Кроме этого на странице отображаются поля:
- **"Имя"**
- **"Фамилия"**
- **"Телефон"**
- **"Емаил"**
- **"Пароль"**
- **"Подтверждение пароля"**
- **"Уже есть аккаунт? Войдите"** - ссылка на авторизацию
- Кнопка **"Зарегистрироваться"**

После указания всех данных и нажатия на кнопку "Зарегистрироваться" вызываем проксированный роут регистрации.

- Если ошибка, отображаем ее в тосте
- Если вернулся токен то сохраняем токен и переходим на модалку "Успешная регистрация" (на карте)

#### Task. Модалка "Успешная регистрация" (на карте)

| Параметр    | Значение          |
| ----------- | ----------------- |
| Эстимейт    | 4h                |
| Сложность   | 2sp               |
| Исполнитель | [[Юминов Михаил]] |
| Компоненты  | game-ui           |
| Department  | Front-end         | 

Пользователю отображаем уведомление об успешной регистрации и ссылку на кабинет БЦ (например для дева, https://bc-dev-bpt.ooo.ua/ - при клике открываем в **новом** окне). А так же кнопку "Войти".

### Story. QA
#### Task. Дизайн

| Параметр    | Значение         |
| ----------- | ---------------- |
| Эстимейт    | 1h               |
| Сложность   | 0.5sp            |
| Исполнитель | [[Мякушка Юлия]] |
| Компоненты  | game-ui          |
| Department  | Testing          | 

#### Task. Back-end

| Параметр    | Значение         |
| ----------- | ---------------- |
| Эстимейт    | 1h               |
| Сложность   | 1sp              | 
| Исполнитель | [[Мякушка Юлия]] |
| Компоненты  | game-ui          |
| Department  | Testing          |

#### Task. Front-end

| Параметр    | Значение         |
| ----------- | ---------------- |
| Эстимейт    | 2.5h             | 
| Сложность   | 2sp              |
| Исполнитель | [[Мякушка Юлия]] |
| Компоненты  | game-ui          |
| Department  | Testing          |
